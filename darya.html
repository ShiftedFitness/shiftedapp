<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Darya Meal Analysis Test</title>
</head>
<body>
<!-- Chatbase embed loader (bubble) -->
<script>
(function(){
  if(!window.chatbase || window.chatbase("getState") !== "initialized"){
    window.chatbase = (...arguments) => {
      if(!window.chatbase.q){ window.chatbase.q=[]; }
      window.chatbase.q.push(arguments);
    };
    window.chatbase = new Proxy(window.chatbase, {
      get(target, prop){
        if(prop === "q"){ return target.q; }
        return (...args) => target(prop, ...args);
      }
    });
  }
  const onLoad = function(){
    const script = document.createElement("script");
    script.src = "https://www.chatbase.co/embed.min.js";
    script.id = "ls6EbqCtawFYWC6vqtmoy"; // <-- your Chatbase agent ID
    script.domain = "www.chatbase.co";
    document.body.appendChild(script);
  };
  if(document.readyState === "complete"){ onLoad(); }
  else { window.addEventListener("load", onLoad); }
})();
</script>

<script>
// Helper: wait for Chatbase to fully initialize
function chatbaseReady(cb) {
  if (typeof window.chatbase === "function" && window.chatbase("getState") === "initialized") {
    cb();
  } else {
    setTimeout(() => chatbaseReady(cb), 100);
  }
}

chatbaseReady(() => {
  // --- Read URL parameters ---
  const q = new URLSearchParams(location.search);
  const name = q.get("name") || "";
  const diet = q.get("diet") || "";
  const goal = q.get("goal") || "";

  // --- Pass user info into Chatbase ---
  window.chatbase("setCustomFields", { name, diet, goal });

  // --- Set greeting message ---
  const greeting = name
    ? `Hi ${name}! Do you have a photo of your meal for me to analyse?`
    : `Hi! Do you have a photo of your meal for me to analyse?`;

  window.chatbase("setInitialMessages", [greeting]);

  // --- Auto-open the chat bubble ---
  window.chatbase("setOpen", true);

  // --- Register the meal_photo_form ---
  window.chatbase.registerFormSchema({
    meal_photo_form: async () => ({
      fields: [
        { name: "mealPhoto", type: "image", label: "Upload or snap your meal" }
      ],
      submitButtonText: "Analyze meal"
    })
  });

  // --- Register the analyze_meal tool ---
  const PROXY_URL = "https://<your-site>/.netlify/functions/analyze-meal"; // replace with your proxy URL
  window.chatbase.registerTools({
    analyze_meal: async (args) => {
      const imageUrl = args?.imageUrl;
      try {
        const res = await fetch(PROXY_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ imageUrl })
        });
        if (!res.ok) throw new Error(await res.text());
        const data = await res.json();
        return {
          status: "success",
          data: `Estimated macros:\n• ${data.calories} kcal\n• Protein ${data.protein}g\n• Carbs ${data.carbs}g\n• Fat ${data.fat}g`
        };
      } catch (e) {
        return { status: "error", message: "I couldn’t analyze that photo just now." };
      }
    }
  });
});
</script>
</body>
</html>
