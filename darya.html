<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Darya â€” Chat + Meal Analysis</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#0b0c10;--panel:#12141a;--muted:#6b7280;--text:#e5e7eb;--accent:#68e0cf;--accent2:#84fab0;
      --bubble-user:#1e293b;--bubble-bot:#10131a;--border:#1f2430;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#0b0c10, #0f1218 40%,#0b0c10);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--text)}
    .wrap{display:flex;flex-direction:column;height:100svh;max-width:840px;margin:0 auto}
    header{padding:14px 18px;border-bottom:1px solid var(--border);backdrop-filter:saturate(1.2) blur(6px);position:sticky;top:0;background:rgba(16,19,26,.8);z-index:2}
    .brand{display:flex;align-items:center;gap:12px}
    .badge{width:34px;height:34px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:grid;place-items:center;color:#0b0c10;font-weight:700}
    .title{font-weight:700;letter-spacing:.2px}
    .subtitle{font-size:12px;color:var(--muted)}
    .chat{flex:1;overflow:auto;padding:18px 14px 8px}
    .row{display:flex;gap:10px;margin:10px 0}
    .row.bot{justify-content:flex-start}
    .row.user{justify-content:flex-end}
    .avatar{width:28px;height:28px;border-radius:8px;background:#111;border:1px solid var(--border);display:grid;place-items:center;font-size:14px;color:#cbd5e1;flex:0 0 auto}
    .bubble{max-width:min(80%,600px);padding:12px 14px;border-radius:14px;border:1px solid var(--border);line-height:1.4;white-space:pre-wrap}
    .bot .bubble{background:var(--bubble-bot)}
    .user .bubble{background:var(--bubble-user)}
    .typing{display:inline-block;min-width:36px}
    .dot{display:inline-block;width:6px;height:6px;background:#9aa3b2;border-radius:50%;margin:0 2px;animation:b 1.2s infinite}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes b{0%,80%,100%{opacity:.2;transform:translateY(0)}40%{opacity:1;transform:translateY(-2px)}}
    .inputbar{position:sticky;bottom:0;padding:10px;border-top:1px solid var(--border);background:rgba(16,19,26,.9);backdrop-filter:blur(8px);z-index:3}
    .ibox{display:flex;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:8px}
    .ibox input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:15px}
    .btn{border:1px solid var(--border);background:#0f1218;color:var(--text);border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .ghost{background:transparent;border-color:var(--border)}
    .attach{width:36px;height:36px;border-radius:10px;border:1px dashed var(--border);display:grid;place-items:center;cursor:pointer}
    .tools{display:flex;gap:8px;margin:8px 2px 0 2px;flex-wrap:wrap}
    .chip{border:1px solid var(--border);padding:6px 10px;border-radius:999px;font-size:13px;color:#cbd5e1;cursor:pointer}
    .pill{font-size:12px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="badge">D</div>
        <div>
          <div class="title">Darya</div>
          <div class="subtitle">Coach chat â€¢ Meal photo analysis</div>
        </div>
      </div>
    </header>

    <main id="chat" class="chat" aria-live="polite"></main>

    <div class="inputbar">
      <div class="ibox">
        <label for="file" class="attach" title="Upload meal photo">
          <input id="file" type="file" accept="image/*" hidden />
          ðŸ“·
        </label>
        <input id="text" placeholder="Ask me anything, or describe your mealâ€¦" autocomplete="off" />
        <button id="send" class="btn">Send</button>
      </div>
      <div class="tools">
        <span class="pill">Tip: JPG/PNG/WebP â‰¤ 2MB recommended</span>
        <button id="quick-photo" class="chip">Analyze a meal photo</button>
        <button id="quick-help" class="chip">Form tips for my exercise</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   CONFIG â€” change these
   ========================= */
const CONFIG = {
  BACKEND_BASE: "https://<your-site>.netlify.app", // e.g. https://shifted-fitness-ai.netlify.app
  CHAT_ENDPOINT: "/.netlify/functions/chat",        // streams assistant text
  ANALYZE_ENDPOINT: "/.netlify/functions/analyze-meal", // accepts image file OR imageUrl JSON
  // If your analyze endpoint expects a URL instead of file, set USE_FILE_UPLOAD=false.
  USE_FILE_UPLOAD: true
};

// Read optional personalization from URL (?name=&diet=&goal=&uid=)
const qs = new URLSearchParams(location.search);
const ctx = {
  uid:  qs.get("uid")  || null,
  name: qs.get("name") || null,
  diet: qs.get("diet") || null,
  goal: qs.get("goal") || null,
};

// Basic chat state
const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('text');
const fileEl  = document.getElementById('file');
const sendEl  = document.getElementById('send');
const quickPhotoEl = document.getElementById('quick-photo');
const quickHelpEl  = document.getElementById('quick-help');
let history = []; // {role:"user"|"assistant", content:string}

/* ========== UI helpers ========== */
function scrollToBottom(){ chatEl.scrollTop = chatEl.scrollHeight; }
function row({role, html}){
  const r = document.createElement('div'); r.className = `row ${role}`;
  const avatar = document.createElement('div'); avatar.className='avatar';
  avatar.textContent = role === 'bot' ? 'D' : 'U';
  const bubble = document.createElement('div'); bubble.className='bubble'; bubble.innerHTML = html;
  r.append(role==='bot'?avatar:null, bubble, role==='user'?avatar:null);
  chatEl.appendChild(r); scrollToBottom(); return bubble;
}
function typingRow(){
  const b = row({role:'bot', html:`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`});
  return { remove: ()=> b.parentElement.remove() }
}
function escapeHTML(s){return s.replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}

/* ========== Client-side image shrink (to keep uploads snappy) ========== */
async function downscaleImage(file, maxSide=1600, quality=0.82){
  const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=URL.createObjectURL(file); });
  const canvas = document.createElement('canvas'); const ctx2 = canvas.getContext('2d');
  let {width, height} = img;
  const scale = Math.min(1, maxSide / Math.max(width,height));
  width = Math.round(width*scale); height = Math.round(height*scale);
  canvas.width = width; canvas.height = height;
  ctx2.drawImage(img,0,0,width,height);
  let blob = await new Promise(r=>canvas.toBlob(r, 'image/jpeg', quality));
  // ensure under ~1.5MB by reducing quality if needed
  let q = quality;
  while (blob && blob.size > 1.5*1024*1024 && q > 0.5){
    q -= 0.06;
    blob = await new Promise(r=>canvas.toBlob(r,'image/jpeg', q));
  }
  return blob || file; // fallback to original if toBlob failed
}

/* ========== Streaming chat to your backend ========== */
async function sendChat(message){
  if(!message.trim()) return;
  // render user message
  history.push({role:'user', content: message});
  row({role:'user', html: escapeHTML(message)});
  inputEl.value='';
  // typing indicator
  const t = typingRow();
  try{
    const body = { ctx, history, stream: true };
    const res = await fetch(CONFIG.BACKEND_BASE + CONFIG.CHAT_ENDPOINT, {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify(body)
    });
    if(!res.ok || !res.body){ throw new Error('Chat endpoint error'); }
    // stream tokens
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let done, buf = '';
    // create assistant bubble and grow text as we stream
    const bubble = row({role:'bot', html: ''});
    chatEl.removeChild(bubble.parentElement); // remove because we created extra; re-add after removing typing
    t.remove();
    const r2 = row({role:'bot', html: ''}); const bubble2 = r2.querySelector('.bubble');

    while(true){
      ({done, value} = await reader.read());
      if(done) break;
      buf += decoder.decode(value, {stream:true});
      bubble2.textContent = buf; scrollToBottom();
    }
    history.push({role:'assistant', content: buf.trim()});
  }catch(e){
    t.remove();
    row({role:'bot', html:"Sorry, I couldn't reach the chat service. Please try again."});
  }
}

/* ========== Analyze meal flow ========== */
async function analyzeFile(file){
  const botWait = typingRow();
  try{
    const tiny = await downscaleImage(file);
    // Send either as multipart file or JSON URL depending on backend
    let res;
    if (CONFIG.USE_FILE_UPLOAD){
      const form = new FormData();
      form.append('file', tiny, 'meal.jpg');
      form.append('uid', ctx.uid || '');
      res = await fetch(CONFIG.BACKEND_BASE + CONFIG.ANALYZE_ENDPOINT, { method:'POST', body: form });
    } else {
      // if you already uploaded to Adalo/S3 and have a URL, send {imageUrl}
      res = await fetch(CONFIG.BACKEND_BASE + CONFIG.ANALYZE_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ imageUrl: URL.createObjectURL(tiny), uid: ctx.uid || '' })
      });
    }
    if(!res.ok){ throw new Error(await res.text()); }
    const data = await res.json(); // {calories,protein,carbs,fat,name?,description?,tips?:[],praise?:string}
    botWait.remove();
    const title = data.name ? `<strong>${escapeHTML(data.name)}</strong>` : `Meal estimate`;
    const desc  = data.description ? `<div>${escapeHTML(data.description)}</div>` : '';
    const tips  = Array.isArray(data.tips) && data.tips.length
      ? `<br><u>Make it even better</u>:<br>â€¢ ${data.tips.map(escapeHTML).join('<br>â€¢ ')}`
      : (data.praise ? `<br>${escapeHTML(data.praise)}` : '');
    const msg =
      `${title}${desc}
â€¢ ${Math.round(data.calories)} kcal
â€¢ Protein ${Math.round(data.protein)} g
â€¢ Carbs ${Math.round(data.carbs)} g
â€¢ Fat ${Math.round(data.fat)} g
Does this look about right?${tips ? '\n'+tips : ''}`;
    history.push({role:'assistant', content: msg});
    row({role:'bot', html: msg.replace(/\n/g,'<br>')});
  }catch(e){
    botWait.remove();
    row({role:'bot', html:"I couldnâ€™t analyze that photo just now. Try a clear JPG/PNG under 2MB with the whole meal visible."});
  }
}

/* ========== Wire up UI ========== */
sendEl.addEventListener('click', ()=> sendChat(inputEl.value));
inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(inputEl.value); }});
quickHelpEl.addEventListener('click', ()=>{
  sendChat("Can you give me 3 form fixes, 1 coaching cue, and 1 safety note for my next workout move?");
});
quickPhotoEl.addEventListener('click', ()=> fileEl.click());
fileEl.addEventListener('change', ()=>{
  const f = fileEl.files?.[0]; if(!f) return;
  // Show a small preview in chat (optimistic UI)
  const url = URL.createObjectURL(f);
  row({role:'user', html:`ðŸ“· <span class="mono">Photo selected</span>`});
  row({role:'bot', html:`Image received â€” analyzing nowâ€¦`});
  analyzeFile(f);
});

/* ========== Warm greeting ========== */
(function greet(){
  const hi = ctx.name ? `Hi ${ctx.name}!` : "Hi!";
  row({role:'bot', html: `${hi} Iâ€™m Darya. You can ask me for coaching or upload a meal photo for a quick macro estimate.`});
})();
</script>
</body>
</html>
