<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Darya â€” Chat + Meal Analysis</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <style>
    :root{
      --bg: #fcf7ea;
      --header-bg: #0a5247;
      --panel: #ffffff;
      --text: #0f172a;
      --muted: #4b5563;
      --border: #e6e1d5;
      --bubble-bot: #ffffff;
      --bubble-user: #0a5247;
      --bubble-user-text: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 16px;
      --brand-img: url("https://res.cloudinary.com/dbfvogb95/image/upload/v1755002016/cropped_image_4_z8egmj.png");
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: var(--bg);
    }

    .wrap{height:100svh;max-width:880px;margin:0 auto;display:flex;flex-direction:column;background:var(--bg)}

    /* Header */
    header{
      position:sticky; top:0; z-index:3;
      padding:14px 18px;
      background: var(--header-bg);
      color:#ffffff;
      border-bottom:1px solid rgba(0,0,0,.08);
      box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }
    .brand{display:flex;align-items:center;gap:12px}
    .badge{
      width:40px;height:40px;border-radius:12px;overflow:hidden;
      display:grid;place-items:center;background:#fff;
      box-shadow: var(--shadow); flex:0 0 auto;
    }
    .badge img{width:100%;height:100%;object-fit:contain} /* full image, not cropped */
    .title{font-weight:400; letter-spacing:.2px; font-size:18px} /* normal weight text */

    /* Chat */
    .chat{flex:1;overflow:auto;padding:18px 14px 8px;background:var(--bg)}
    .row{display:flex;gap:10px;margin:12px 0; align-items:flex-end}
    .row.bot{justify-content:flex-start}
    .row.user{justify-content:flex-end}
    .avatar{
      width:28px;height:28px;border-radius:10px;flex:0 0 auto;display:grid;place-items:center;
      border:1px solid var(--border); background:#fff; color:#334155; font-size:13px; overflow:hidden
    }
    .avatar img{width:100%;height:100%;object-fit:contain} /* full image for bot icon */
    .bubble{
      max-width:min(78%,640px);
      padding:12px 14px; border-radius:14px; border:1px solid var(--border);
      background:var(--bubble-bot); line-height:1.5; white-space:pre-wrap; box-shadow: var(--shadow);
    }
    .user .bubble{ background:var(--bubble-user); color:var(--bubble-user-text); border-color:rgba(0,0,0,.06) }
    .bubble h4{margin:.1rem 0 .4rem 0; font-size:14px}
    .meta{font-size:12px;color:var(--muted); margin-top:6px}

    /* Typing */
    .typing{display:inline-flex;gap:4px;align-items:center}
    .dot{width:6px;height:6px;border-radius:50%;background:#94a3b8;animation:b 1.2s infinite}
    .dot:nth-child(2){animation-delay:.15s}.dot:nth-child(3){animation-delay:.3s}
    @keyframes b{0%,80%,100%{opacity:.25;transform:translateY(0)}40%{opacity:1;transform:translateY(-2px)}}

    /* Input bar */
    .inputbar{
      position:sticky;bottom:0;padding:10px; background: var(--bg);
      border-top:1px solid var(--border); z-index:2
    }
    .ibox{
      display:flex;gap:8px;align-items:center;background:var(--panel);
      border:1px solid var(--border); border-radius:14px; padding:8px 8px 8px 10px;
      box-shadow: var(--shadow)
    }
    .ibox input{flex:1;background:transparent;border:0;outline:0;color:var(--text);font-size:15px}
    .btn{
      border:1px solid var(--border); background:#ffffff; color:#0f172a;
      border-radius:12px; padding:10px 12px; font-weight:700; cursor:pointer; transition:.15s
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:disabled{opacity:.55;cursor:not-allowed;transform:none}
    .attach{width:36px;height:36px;border-radius:10px;border:1px dashed var(--border);display:grid;place-items:center;cursor:pointer}
    #mic.listening{ outline: 2px solid #0a5247; box-shadow: 0 0 0 4px rgba(10,82,71,.15); }

    /* Progress bar */
    .bar{height:3px;background:linear-gradient(90deg,#0a5247,#31a497);border-radius:999px;transform:scaleX(0);transform-origin:left;transition:transform .25s}

    /* Drag & drop overlay */
    .dropmask{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.15);z-index:10}
    .dropmask.on{display:flex}
    .dropbox{border:2px dashed #94a3b8;border-radius:18px;padding:24px 28px;background:rgba(255,255,255,.7);backdrop-filter: blur(4px); color:#0f172a}

    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="badge">
          <img src="https://res.cloudinary.com/dbfvogb95/image/upload/v1755002016/cropped_image_4_z8egmj.png" alt="Darya icon" />
        </div>
        <div class="title">Darya</div>
      </div>
    </header>

    <main id="chat" class="chat" aria-live="polite"></main>

    <div class="inputbar">
      <div class="ibox">
        <label for="file" class="attach" title="Upload meal photo">
          <input id="file" type="file" accept="image/*" hidden />
          ðŸ“·
        </label>
        <button id="mic" class="btn" aria-pressed="false" title="Voice input">ðŸŽ¤</button>
        <input id="text" placeholder="Ask me somethingâ€¦ or describe your meal" autocomplete="off" />
        <button id="send" class="btn">Send</button>
      </div>
      <div id="progress" class="bar" aria-hidden="true"></div>
    </div>
  </div>

  <!-- Drag & drop overlay -->
  <div id="dropmask" class="dropmask" aria-hidden="true">
    <div class="dropbox">Drop your meal photo to analyze</div>
  </div>

<script>
/* Config */
const CONFIG = {
  BACKEND_BASE: "https://<your-site>.netlify.app",
  CHAT_ENDPOINT: "/.netlify/functions/chat",
  ANALYZE_ENDPOINT: "/.netlify/functions/analyze-meal",
  USE_FILE_UPLOAD: true
};
const qs = new URLSearchParams(location.search);
const ctx = { uid: qs.get("uid")||null, name: qs.get("name")||null, diet: qs.get("diet")||null, goal: qs.get("goal")||null };

const chatEl = document.getElementById('chat');
const inputEl = document.getElementById('text');
const fileEl  = document.getElementById('file');
const sendEl  = document.getElementById('send');
const dropmask = document.getElementById('dropmask');
const progress = document.getElementById('progress');
let history = [];

/* Helpers */
function scrollToBottom(){ chatEl.scrollTop = chatEl.scrollHeight; }
function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[m])); }
function row({role, html}){
  const r = document.createElement('div'); r.className = `row ${role}`;
  const avatar = document.createElement('div'); avatar.className='avatar';
  if (role === 'bot') {
    const img = document.createElement('img');
    img.src = "https://res.cloudinary.com/dbfvogb95/image/upload/v1755002016/cropped_image_4_z8egmj.png";
    img.alt = "Darya";
    avatar.appendChild(img);
  } else {
    avatar.textContent = 'U';
  }
  const bubble = document.createElement('div'); bubble.className='bubble'; bubble.innerHTML = html;
  if (role === 'bot') { r.append(avatar, bubble); } else { r.append(bubble, avatar); }
  chatEl.appendChild(r); scrollToBottom(); return bubble;
}
function typingRow(){
  const b = row({role:'bot', html:`<span class="typing"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`});
  return { remove: ()=> b.parentElement.remove() }
}

/* Chat send */
async function sendChat(message){
  if(!message.trim()) return;
  history.push({role:'user', content: message});
  row({role:'user', html: escapeHTML(message) });
  inputEl.value='';
  const t = typingRow();
  try{
    const res = await fetch(CONFIG.BACKEND_BASE + CONFIG.CHAT_ENDPOINT, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ ctx, history, stream: true })
    });
    if(!res.ok || !res.body) throw new Error('Chat endpoint error');
    t.remove();
    const bubble = row({role:'bot', html:''});
    const reader = res.body.getReader();
    const decoder = new TextDecoder(); let buf=''; let done;
    while(true){
      ({done, value} = await reader.read());
      if(done) break;
      buf += decoder.decode(value, {stream:true});
      bubble.textContent = buf; scrollToBottom();
    }
    history.push({role:'assistant', content: buf.trim()});
  }catch(e){
    t.remove();
    row({role:'bot', html:"Sorry, I couldnâ€™t reach the chat service. Please try again."});
  }
}

/* Voice-to-text always visible */
(function setupVoice(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  const micEl = document.getElementById('mic');

  async function ensureMicAccess(){
    if (!navigator.mediaDevices?.getUserMedia) return true;
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(t=>t.stop());
      return true;
    }catch(e){ return false; }
  }

  if(!SR){
    micEl.addEventListener('click', ()=>{
      row({role:'bot', html:`Voice input isnâ€™t supported in this environment. You can still type or upload a photo.`});
    });
    return;
  }

  const rec = new SR();
  rec.lang = 'en-US';
  rec.continuous = false;
  rec.interimResults = true;
  let listening = false;
  let finalText = '';

  function start(){
    finalText = '';
    try { rec.start(); } catch(_) {}
    listening = true;
    micEl.classList.add('listening');
    micEl.setAttribute('aria-pressed','true');
    if (!inputEl.value) inputEl.placeholder = 'Listeningâ€¦ speak now';
  }
  function stop(){
    try { rec.stop(); } catch(_) {}
    listening = false;
    micEl.classList.remove('listening');
    micEl.setAttribute('aria-pressed','false');
    inputEl.placeholder = 'Ask me somethingâ€¦ or describe your meal';
  }

  micEl.addEventListener('click', async () => {
    const ok = await ensureMicAccess();
    if(!ok){
      row({role:'bot', html:`I couldnâ€™t access the microphone. Please allow mic access in app settings and try again.`});
      return;
    }
    listening ? stop() : start();
  });

  rec.onresult = (evt) => {
    let interim = '';
    for (let i=evt.resultIndex; i<evt.results.length; i++){
      const chunk = evt.results[i][0].transcript;
      if (evt.results[i].isFinal) finalText += chunk + ' ';
      else interim += chunk;
    }
    inputEl.value = (finalText + interim).trim();
  };

  rec.onerror = (e) => {
    stop();
    const msg = e.error === 'not-allowed'
      ? 'Microphone access was blocked. Please enable it in settings and try again.'
      : 'I couldnâ€™t hear anything. Try again.';
    row({role:'bot', html: msg});
  };

  rec.onend = () => {
    if (finalText.trim()) sendChat(inputEl.value);
    stop();
  };
})();

/* Wire up events */
sendEl.addEventListener('click', ()=> sendChat(inputEl.value));
inputEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendChat(inputEl.value); }});

/* Greeting */
(function greet(){
  const hi = ctx.name ? `Hi ${ctx.name}!` : "Hi!";
  row({role:'bot', html: `${hi} Iâ€™m Darya. Upload a meal photo for a quick macro estimate, or ask me for coaching.`});
})();
</script>
</body>
</html>
