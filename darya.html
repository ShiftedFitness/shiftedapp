<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Darya • Adalo Update Test</title>
  <style>html,body{height:100%;margin:0;background:#000;}</style>
  <script>
  (function(){
    // --- 1) Read minimal params ---
    const qp     = new URLSearchParams(location.search);
    const NAME   = (qp.get("name") || "").trim();
    const USER_ID= (qp.get("uid")  || "").trim(); // MUST be Adalo Users record ID

    // --- 2) Adalo DEV credentials (TEST ONLY – okay to rotate later) ---
    const ADALO_APP_ID        = "36c20042-6d02-4fc8-a289-62cfb2fcf217";
    const ADALO_COLLECTION_ID = "_1470aa94bbc4403fb29e3bd343796143";
    const ADALO_API_KEY       = "Bearer 0198ogjmyhxxkvkbv9iztrtv";
    const ADALO_ENDPOINT =
      `https://api.adalo.com/v0/apps/${ADALO_APP_ID}/collections/${ADALO_COLLECTION_ID}/records/${encodeURIComponent(USER_ID)}`;

    // --- 3) Chatbase stub ---
    if(!window.chatbase || window.chatbase("getState")!=="initialized"){
      window.chatbase = (...args)=>{ (window.chatbase.q = window.chatbase.q || []).push(args); };
      window.chatbase = new Proxy(window.chatbase,{ get(t,p){ if(p==="q") return t.q; return (...a)=>t(p,...a) }});
    }

    // Intro kept super explicit for testing
    const intro = `Hi ${NAME || "there"} — reply with 3, 4, or 5 and I’ll try to update your Training_Days in Adalo now.`;

    window.chatbase("setInitialMessages", [intro]);
    window.chatbase("identify", { user_id: USER_ID || undefined });

    // --- 4) Handle user reply -> PATCH Adalo ---
    async function patchAdalo(newDays){
      console.log("[TEST] PATCH to Adalo", ADALO_ENDPOINT, {Training_Days: newDays});
      try{
        const res = await fetch(ADALO_ENDPOINT, {
          method: "PATCH",
          headers: {
            "Content-Type": "application/json",
            "Authorization": ADALO_API_KEY
          },
          body: JSON.stringify({ Training_Days: newDays })
        });
        const text = await res.text();
        console.log("[TEST] Adalo response", res.status, text);
        if(!res.ok) throw new Error(`HTTP ${res.status} – ${text || "Update failed"}`);
        window.chatbase("sendMessage", { text: `✅ Updated to ${newDays} days/week.` });
      }catch(err){
        console.error("[TEST] Adalo error", err);
        window.chatbase("sendMessage", { text: `❌ Couldn't update: ${err.message}` });
      }
    }

    window.chatbase("onMessage", (msg) => {
      const val = parseInt((msg.text || "").trim(), 10);
      if (![3,4,5].includes(val)) {
        window.chatbase("sendMessage", { text: "Please reply with 3, 4, or 5." });
        return;
      }
      if (!USER_ID) {
        window.chatbase("sendMessage", { text: "Missing user ID — can't update." });
        return;
      }
      patchAdalo(val);
    });

    // --- 5) Load Chatbase + auto-open ---
    const onLoad = function(){
      const s = document.createElement("script");
      s.src = "https://www.chatbase.co/embed.min.js";
      s.id  = "qZ1zajTDomWA0ko7xP5MK"; // your bot id
      s.domain = "www.chatbase.co";
      document.body.appendChild(s);
      window.chatbase("open");
      setTimeout(()=>window.chatbase("open"), 350);
      setTimeout(()=>window.chatbase("open"), 900);
    };
    if (document.readyState === "complete") onLoad(); else window.addEventListener("load", onLoad);
  })();
  </script>
</head>
<body></body>
</html>
