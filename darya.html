<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Darya – Meal Analysis (auto form)</title>
</head>
<body>
<!-- Chatbase bubble embed -->
<script>
(function(){
  if(!window.chatbase || window.chatbase("getState")!=="initialized"){
    window.chatbase=(...a)=>{(window.chatbase.q ||= []).push(a)};
    window.chatbase=new Proxy(window.chatbase,{get(t,p){return p==="q"?t.q:(...x)=>t(p,...x)}});
  }
  const onLoad=()=>{const s=document.createElement("script");
    s.src="https://www.chatbase.co/embed.min.js";
    s.id="ls6EbqCtawFYWC6vqtmoy"; s.domain="www.chatbase.co"; document.body.appendChild(s);
  };
  document.readyState==="complete"?onLoad():window.addEventListener("load",onLoad);
})();
</script>

<script>
// wait until widget init
function ready(cb){ if(typeof chatbase==="function" && chatbase("getState")==="initialized") cb(); else setTimeout(()=>ready(cb),100); }

ready(() => {
  // params for greeting/prompt context
  const qs=new URLSearchParams(location.search);
  const name=qs.get("name")||""; const diet=qs.get("diet")||""; const goal=qs.get("goal")||"";
  window.chatbase("setCustomFields",{name,diet,goal});
  window.chatbase("setInitialMessages",[
    name?`Hi ${name}! Do you have a photo of your meal for me to analyse?`:
          `Hi! Do you have a photo of your meal for me to analyse?`,
    `Upload a clear photo (JPG/PNG/WebP under 2MB).`
  ]);

  // open bubble
  window.chatbase.open();

  // -------- 1) FORCE-SHOW FORM IMMEDIATELY (client-driven) --------
  // This bypasses the model needing to "call the form"
  const showUploadForm = () => {
    window.chatbase("sendForm", {
      form: {
        title: "Upload your meal",
        fields: [{ type:"image", name:"mealPhoto", label:"Upload or snap your meal (≤2MB JPG/PNG/WebP)" }],
        submitLabel: "Analyze meal"
      },
      callback: async (values) => {
        // UX: status line
        window.chatbase("sendMessage","Image received — analyzing now…");
        const imageUrl = values?.mealPhoto;
        try {
          const res = await fetch("https://<your-site>/.netlify/functions/analyze-meal",{
            method:"POST", headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ imageUrl })
          });
          if(!res.ok) throw new Error(await res.text());
          const data = await res.json(); // {calories,protein,carbs,fat,name?,description?,notes?}

          const title = data.name ? `Meal: ${data.name}` : `Meal estimate`;
          const desc  = data.description ? `\n${data.description}` : "";
          const notes = data.notes ? `\nNote: ${data.notes}` : "";
          window.chatbase("sendMessage",
            `${title}${desc}\n• ${data.calories} kcal\n• Protein ${data.protein} g\n• Carbs ${data.carbs} g\n• Fat ${data.fat} g${notes}\n` +
            `Does this look about right?`
          );
        } catch(err){
          window.chatbase("sendMessage","I couldn’t analyze that photo just now. Please try again in a moment.");
        }
      }
    });
  };

  // show the form right away
  showUploadForm();

  // -------- 2) (Optional) also register tools/forms for LLM-driven path --------
  window.chatbase.registerFormSchema({
    meal_photo_form: async ()=>({
      fields:[{name:"mealPhoto",type:"image",label:"Upload or snap your meal (≤2MB JPG/PNG/WebP)"}],
      submitButtonText:"Analyze meal"
    })
  });

  window.chatbase.registerTools({
    analyze_meal: async (args)=>({ status:"error", message:"Direct analyze disabled in fallback mode." })
    // ^ keep stubbed if you’re relying on the client-driven flow above.
    // Once your proxy is solid, you can reuse the same fetch here.
  });
});
</script>
</body>
</html>
